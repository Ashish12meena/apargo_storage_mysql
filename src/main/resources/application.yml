# ── application.yml ───────────────────────────────────────────────────────────
spring:
  profiles:
    include:
      - resilience        # was "resilence" typo — rename the file too
      - database
      - media
      - eureka
      - redis
  web:
    resources:
      add-mappings: false
  application:
    name: storage-service
  servlet:
    multipart:
      enabled: true
      max-file-size: 50MB
      max-request-size: 50MB
  flyway:
    enabled: true
    baseline-on-migrate: true
    locations: classpath:db/migration

server:
  port: 7998

# Rate Limiting (Bucket4j)
rate-limiting:
  enabled: true
  default-capacity: 100
  default-refill-tokens: 100
  default-refill-duration: 1m
  endpoints:
    upload:
      capacity: 30           # Max burst of 30
      refill-tokens: 30      # Refill 30 tokens per minute
      refill-duration: 1m
    get-media:
      capacity: 100
      refill-tokens: 100
      refill-duration: 1m

# Scheduled Cleanup
file-cleanup:
  enabled: true
  temp-file-max-age-hours: 24
  cron: "0 0 2 * * ?"

# Pagination
pagination:
  max-page-size: 100
  default-page-size: 20
  min-page-size: 1

# Logging
logging:
  level:
    com.aigreentick.services.storage: DEBUG

# Actuator
management:
  endpoints:
    web:
      exposure:
        include: info,health,metrics,prometheus,env,beans,loggers
  endpoint:
    health:
      show-details: always

info:
  app:
    name: Storage Service
    version: '@project.version@'
    description: Handles file storage and media management for Aigreentick
  author:
    name: Ashish Meena
    organization: Aigreentick

# Swagger
springdoc:
  api-docs:
    path: /api-docs
  swagger-ui:
    path: /swagger-ui.html
    operations-sorter: method
  packages-to-scan: com.aigreentick.services.storage.controller

# ── application-storage.yml ───────────────────────────────────────────────────
# NOTE: Remove this file from .gitignore — it has no secrets.
# Provider-specific secrets (accessKey, secretKey) should come from env vars.
storage:
  active-provider: local       # switch to "s3" for production

  providers:
    local:
      enabled: true
      root-path: ./media-uploads
      base-url: http://localhost:7998/api/v1/media/serve/

    s3:
      enabled: false
      bucket: ${S3_BUCKET:aigreentick-media}
      region: ${S3_REGION:ap-south-1}
      access-key: ${AWS_ACCESS_KEY_ID:}
      secret-key: ${AWS_SECRET_ACCESS_KEY:}
      use-iam-role: false
      multipart-threshold-bytes: 104857600   # 100 MB
      presigned-url-expiry-minutes: 15

# ── application-eureka.yml ────────────────────────────────────────────────────
eureka:
  client:
    service-url:
      defaultZone: http://localhost:8888/eureka/
    register-with-eureka: true
    fetch-registry: true
    enabled: false

# Fixed: was colliding — now uses separate prefixes
user-service:
  base-url: http://localhost:7999
  api-version: v1
  outgoing-enabled: true

waba-service:            # fixed prefix (was also "user-service")
  base-url: http://localhost:8001
  outgoing-enabled: true

whatsapp-service:
  api-version: v23.0
  base-url: https://graph.facebook.com
  outgoing-enabled: true

# ── application-resilience.yml (typo fixed from "resilence") ─────────────────
resilience4j:
  retry:
    instances:
      whatsappMediaRetry:
        max-attempts: 3
        wait-duration: 1s
      facebookUploadRetry:
        max-attempts: 3
        wait-duration: 1s
      organisationCB:
        max-attempts: 2
        wait-duration: 500ms

  circuit-breaker:
    instances:
      whatsappMediaCB:
        sliding-window-size: 20
        failure-rate-threshold: 50
        wait-duration-in-open-state: 10s
        permitted-number-of-calls-in-half-open-state: 5
        minimum-number-of-calls: 10
        automatic-transition-from-open-to-half-open-enabled: true
      facebookUploadCB:
        sliding-window-size: 20
        failure-rate-threshold: 50
        wait-duration-in-open-state: 10s
        minimum-number-of-calls: 10
      organisationCB:
        sliding-window-size: 10
        failure-rate-threshold: 60
        wait-duration-in-open-state: 15s
        minimum-number-of-calls: 5

  rate-limiter:
    instances:
      whatsappMediaRL:
        limit-for-period: 10
        limit-refresh-period: 1s
        timeout-duration: 0ms
      facebookUploadRL:
        limit-for-period: 5
        limit-refresh-period: 1s
        timeout-duration: 0ms


quota:
  reconciliation:
    enabled: true
    cron: "0 0 3 * * ?"
web:
    resources:
      add-mappings: false